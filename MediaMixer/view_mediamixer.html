<!DOCTYPE html>
<html>
<head>
    <title>Media Mixer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .slider.active {
            background-color: #4CAF50;
        }
        .slider-button {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider.active .slider-button {
            transform: translateX(30px);
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Media Mixer WebSocket Test</h1>

    <div class="controls">
        <div class="toggle">
            <label>Camera:</label>
            <div class="slider" id="cameraSlider">
                <div class="slider-button"></div>
            </div>
        </div>
        <div class="toggle">
            <label>Screen Share:</label>
            <div class="slider" id="screenSlider">
                <div class="slider-button"></div>
            </div>
        </div>
    </div>

    <div class="status" id="status">
        WebSocket: Disconnected | Camera: Off | Screen Share: Off
    </div>

    <img id="stream" alt="WebSocket Stream" width="300" height="600" style="border: 1px solid black;"/>

    <script>
        const img = document.getElementById('stream');
        const cameraSlider = document.getElementById('cameraSlider');
        const screenSlider = document.getElementById('screenSlider');
        const statusDiv = document.getElementById('status');

        // Dual WebSocket connections
        const commandWs = new WebSocket('ws://localhost:8765');
        const videoWs = new WebSocket('ws://localhost:8766');

        let cameraEnabled = true;
        let screenEnabled = true;
        let commandWsConnected = false;
        let videoWsConnected = false;

        function updateStatus() {
            const wsStatus = (commandWsConnected && videoWsConnected) ? 'Connected' : 'Disconnected';
            const cameraStatus = cameraEnabled ? 'On' : 'Off';
            const screenStatus = screenEnabled ? 'On' : 'Off';
            statusDiv.textContent = `WebSocket: ${wsStatus} | Camera: ${cameraStatus} | Screen Share: ${screenStatus}`;
        }

        function sendCommand(command) {
            if (commandWsConnected) {
                commandWs.send(JSON.stringify(command));
                console.log('Sent command:', command);
            } else {
                console.log('Command WebSocket not connected, cannot send command:', command);
            }
        }

        cameraSlider.addEventListener('click', () => {
            cameraEnabled = !cameraEnabled;
            cameraSlider.classList.toggle('active', cameraEnabled);
            sendCommand({ type: 'toggle_camera', data: { enabled: cameraEnabled } });
            updateStatus();
        });

        screenSlider.addEventListener('click', () => {
            screenEnabled = !screenEnabled;
            screenSlider.classList.toggle('active', screenEnabled);
            sendCommand({ type: 'toggle_screen', data: { enabled: screenEnabled } });
            updateStatus();
        });

        // Initialize toggle states on load
        cameraSlider.classList.toggle('active', cameraEnabled);
        screenSlider.classList.toggle('active', screenEnabled);

        // Command WebSocket handlers
        commandWs.onopen = () => {
            console.log('Command WebSocket connection established');
            commandWsConnected = true;
            updateStatus();

            // Send initial commands to set backend state
            sendCommand({ type: 'toggle_camera', data: { enabled: cameraEnabled } });
            sendCommand({ type: 'toggle_screen', data: { enabled: screenEnabled } });
        };

        commandWs.onclose = (event) => {
            console.log('Command WebSocket connection closed', event);
            commandWsConnected = false;
            updateStatus();
        };

        commandWs.onerror = (error) => {
            console.error('Command WebSocket error:', error);
            commandWsConnected = false;
            updateStatus();
        };

        // Video WebSocket handlers
        videoWs.onopen = () => {
            console.log('Video WebSocket connection established');
            videoWsConnected = true;
            updateStatus();
        };

        videoWs.onmessage = (event) => {
            console.log('Received frame');
            img.src = 'data:image/jpeg;base64,' + event.data;
        };

        videoWs.onclose = (event) => {
            console.log('Video WebSocket connection closed', event);
            videoWsConnected = false;
            updateStatus();
        };

        videoWs.onerror = (error) => {
            console.error('Video WebSocket error:', error);
            videoWsConnected = false;
            updateStatus();
        };

        updateStatus();
    </script>
</body>
</html>
