name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - staging
      - staging-deployed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: aitutor-473420
          
      - name: Authenticate using access token
        env:
          GCP_ACCESS_TOKEN: ${{ secrets.GCP_ACCESS_TOKEN }}
        run: |
          echo "🔐 Authenticating with access token..."
          gcloud auth activate-refresh-token account-name "$GCP_ACCESS_TOKEN" || true
          gcloud config set project aitutor-473420
          gcloud auth list

      - name: Grant execute permissions
        run: chmod +x ./deploy.sh
        
      - name: Install dependencies
        run: |
          chmod +x ./deploy.sh

      - name: Set environment variable
        run: echo "VITE_GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV

      - name: Deploy based on branch
        run: |
          if [ "${{ github.ref_name }}" = "staging" ]; then
            ./deploy.sh staging
          elif [ "${{ github.ref_name }}" = "staging-deployed" ]; then
            ./deploy.sh prod
          fi
